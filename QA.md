# Cross Stage 技術Q&A（完全版）

作品展・技術発表で「即答」するための最強チートシート。
想定される質問（甘口〜激辛）を網羅し、設計意図と実装詳細を言語化しました。

---

## 🎨 プロダクト・体験設計 (UX)

### Q. 一言でいうと何？
**A.** 「音楽に触れる」を体現したWebリズムアクションゲーム。
TextAliveの歌詞解析技術とMediaPipeの身体検知を融合させ、流れてくる歌詞を「掴んで」「奏でる」没入体験を作りました。

### Q. どんなプレイモードがある？
**A.** 3つのモードをデバイスに応じて自動/手動で切り替えます。
- **Cursor**: マウス/タッチ操作（PC/タブレット）。基本モード。
- **Mobile**: スマホ特化。画面下部の歌詞表示を排除し、タップ領域を最大化。親指でのプレイ感を最適化。
- **Body**: Webカメラで全身検知。手や体を歌詞に重ねて「触れる」全身運動モード。

### Q. 判定の特徴は？「ホールド」って何？
**A.** 単なるタップではなく「長押し」でゲージを溜める仕組みです。
- **意図**: 歌詞の「余韻」や「伸び」を表現するため。
- **工夫**: バブルが密集しても誤爆しないよう、ホールド中のバブルを最前面（z-index）に引き上げ、判定ロジックも「指を離さずスライド」に対応させています。

### Q. UIデザインのこだわりは？
**A.** 「没入感」と「視認性」の両立です。
- **Yellow Score Popups**: スコア加算表示を従来のカード型から「文字抜き・黄色・太字」に変更し、視認性を大幅向上。
- **Mobile Optimized**: モバイルでは画面が狭いため、下部の歌詞テキストエリア（Viewer Lyrics）を非表示にし、ゲーム画面を広く確保。
- **Neon/Glass**: 暗闇に光るネオンとグラスモーフィズムで、近未来のライブステージを演出。

### Q. 歌詞同期がズレたり止まったりしない？
**A.** **止まりません（The Show Must Go On）。**
TextAlive APIが不安定な場合やネットワーク切断時でも、フォールバック用の歌詞データと自前タイマーでゲームを継続させる「フォールバック機構」を実装しています。

---

## 🛠️ フロントエンド技術 (React / Vite)

### Q. 技術スタックの選定理由は？
**A.** 「開発速度」と「パフォーマンス」のバランス。
- **React 18 + Vite**: 高速なHMRで試行錯誤を加速。
- **Tailwind CSS**: UI構築の速さと、CSS変数を活用したテーマ管理（ミクグリーン等）の容易さ。
- **Three.js**: 背景の3D演出用。Reactロジックとは切り離して軽量に実装。

### Q. ゲームループはどうなってる？
**A.** `requestAnimationFrame` ベースの独自ループです。
`GameManager` クラスが中心となり、`GameLoop`（時間管理）、`InputManager`（入力）、`LyricsRenderer`（描画）、`EffectsManager`（演出）を統括する **SRP（単一責任の原則）** に基づいた設計です。

### Q. 状態管理ライブラリは？ (Redux/Recoil?)
**A.** **使っていません。**
ゲームのステート（スコア、コンボ等）はReactのレンダリングサイクルとは独立したクラス（GameManager）で管理し、必要な時だけReact側に反映させることで、Reactの再レンダリング負荷を回避し60fpsを維持しています。

### Q. 「徹底したSPA遷移」とは？
**A.** ユーザーの没入感を削がない工夫です。
- `beforeunload` や `popstate` をフックし、ブラウザバック時も独自の確認モーダルを表示。
- 画面遷移時に白画面やロードスピナーを挟まず、シームレスにシーンを切り替えます。

### Q. デバッグ機能はある？
**A.** 展示デモ用に、キーボードで **`hhrg`** と入力すると強制的にリザルト画面へ遷移する裏コマンドを実装しています。

---

## 🔒 バックエンド・セキュリティ (Workers / Supabase)

### Q. なぜ Cloudflare Workers / Hono？
**A.** **「爆速エッジ処理」と「堅牢性」。**
- 全世界のエッジでAPIが実行されるためレイテンシが低い。
- Hono は超軽量で型安全。Durable Objects との親和性も高い。
- Node.jsサーバーを立てるより運用コストが圧倒的に安い（ほぼ無料）。

### Q. セキュリティ対策は？（ガチ勢向け回答）
**A.** **情報処理安全確保支援士レベル**の対策を実装しています。
1.  **Turnstile**: CloudflareのスマートCAPTCHAでボットによるスコア荒らしを排除。
2.  **HMAC署名**: サーバー発行の署名付きトークンがないとスコア登録不可。
3.  **Nonce (Durable Objects)**: トークンの使い回し（リプレイ攻撃）を物理的に阻止。
4.  **CSP / HSTS / Permissions-Policy**: 厳格なセキュリティヘッダでXSSや不正な機能利用をブロック。
5.  **RLS (Supabase)**: クライアントからは読み取りのみ許可。書き込みは署名検証済みのWorkersからのみ許可。

### Q. スコアの二重送信（連打）対策は？
**A.** **Idempotency Key（冪等性キー）** を導入しています。
クライアントが生成した `clientAttemptId` を元に、同じプレイ結果の再送信は無視しつつ、正常なレスポンスを返すことで、ネットワーク不安定時の再試行を安全に処理します。

### Q. 管理機能はある？
**A.** あります。
`/admin/scores` エンドポイントに対し、管理者用トークン（`x-admin-token`）を用いて特定条件のスコア削除や全削除が可能です。誤操作防止のため `confirm` パラメータを必須にしています。

---

## 🧪 パフォーマンス・可用性

### Q. 重い端末への配慮は？
**A.** レンダリング負荷の軽減策を入れています。
- **オブジェクトプーリング**: パーティクルやバブルのDOM要素を再利用し、GC発生を抑制。
- **will-change**: アニメーション要素にGPUアクセラレーションを明示。
- **演出削減**: モバイルや低スペック環境ではThree.js演出を自動で簡易版に切り替え。

### Q. 異常なハイスコア（チート）への対策は？
**A.** **多層防御**で防ぎます。
1.  **バリデーション**: Zodでスコア、コンボ、ランク等の整合性を厳格にチェック。
2.  **閾値制限**: 100万点（理論値）を超えるスコアは `is_suspicious` フラグを立ててランキングから自動除外。
3.  **レート制限**: 同一IPからの過度な連続投稿をブロック。

---

## 💡 「なぜ〇〇じゃないの？」 (FAQ)

### Q. Next.js じゃないの？
**A.** **SSR（サーバーサイドレンダリング）が不要だからです。**
ゲームはクライアントサイドでのインタラクションが全て。ViteによるSPAの方が初期ロード後の挙動が軽く、ホスティングもシンプルになります。

### Q. Canvas で全部描画しないの？
**A.** **DOM操作とCSSアニメーションの方がUI調整が速いからです。**
歌詞バブルの文字折り返しや装飾はHTML/CSSが得意。背景エフェクトのみCanvas(Three.js)に任せるハイブリッド構成が、開発効率と表現力の最適解でした。

### Q. Websocket (Realtime) は使わない？
**A.** **今回はランキング機能のみなので不要です。**
リアルタイム対戦を実装するならDurable ObjectsでWebsocketサーバーを立てますが、現在の仕様ではHTTPリクエスト（REST）で十分かつステートレスで堅牢です。

### Q. AWS や GCP じゃないの？
**A.** **「展示会特化」のデプロイ速度を優先しました。**
Cloudflare Pages/Workersなら、`git push` から数秒で全世界にデプロイ完了。インフラ構築の時間を、ゲームの面白さを磨く時間に充てました。

---

## 🔍 トラブルシューティング（展示現場用）

### Q. カメラが映らない！
**A.**
1. ブラウザのカメラ権限許可を確認。
2. 別のアプリ（Zoom等）がカメラを占有していないか確認。
3. URLパラメータ `?mode=body` を付け直してリロード。

### Q. 音が出ない！
**A.**
ブラウザの自動再生ポリシー制限です。画面を一度クリック/タップしてからリロード、またはスタートボタンを押してください。

### Q. ランキングが出ない！
**A.**
ネットワーク接続を確認してください。オフラインでもゲーム自体はプレイ可能です（スコア送信は失敗しますが、再試行ロジックが働きます）。