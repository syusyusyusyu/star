# Cross Stage (ã‚¯ãƒ­ã‚¹ãƒ†)

**éŸ³æ¥½ã¨ä¸€ä½“åŒ–ã™ã‚‹ã€æ–°æ„Ÿè¦šãƒªã‚ºãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚**

TextAlive ã®æ­Œè©åŒæœŸæŠ€è¡“ã¨ MediaPipe ã®èº«ä½“èªè­˜æŠ€è¡“ã‚’èåˆã€‚
æµã‚Œã‚‹æ­Œè©ã‚’ã€Œç›®ã§è¿½ã„ã€ã€Œæ‰‹ã§è§¦ã‚Œã‚‹ã€ã“ã¨ã§ã€æ¥½æ›²ã®ä¸–ç•Œã«æ²¡å…¥ã§ãã‚‹æ¬¡ä¸–ä»£ã® Web ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ã§ã™ã€‚

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![React](https://img.shields.io/badge/React-18-61DAFB?logo=react&logoColor=black)
![TypeScript](https://img.shields.io/badge/TypeScript-5.0-3178C6?logo=typescript&logoColor=white)
![Vite](https://img.shields.io/badge/Vite-5.0-646CFF?logo=vite&logoColor=white)
![Tailwind CSS](https://img.shields.io/badge/Tailwind_CSS-3.4-38B2AC?logo=tailwind-css&logoColor=white)
![Hono](https://img.shields.io/badge/Hono-Server-E36002?logo=hono&logoColor=white)
![Supabase](https://img.shields.io/badge/Supabase-Database-3ECF8E?logo=supabase&logoColor=white)

---

## âœ¨ ç‰¹å¾´ (Highlights)

### ğŸ® 2ã¤ã®é©æ–°çš„ãªãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰
- **ãƒã‚¦ã‚¹ãƒ¢ãƒ¼ãƒ‰ (Mouse Mode)**:
  - ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã§æ­Œè©ã‚’ã‚­ãƒ£ãƒƒãƒã™ã‚‹ã€ç›´æ„Ÿçš„ã§è»½å¿«ãªãƒ¢ãƒ¼ãƒ‰ã€‚
  - ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯ã‚¿ãƒƒãƒ—æ“ä½œã«è‡ªå‹•æœ€é©åŒ–ã€‚
- **ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ (Camera Mode)**:
  - Webã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã€**å…¨èº«ã‚’ä½¿ã£ã¦**æ­Œè©ã‚’ã‚­ãƒ£ãƒƒãƒã€‚
  - MediaPipe Pose & Selfie Segmentation ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èº«ä½“èªè­˜ã€‚
  - è‡ªåˆ†ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆãŒã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã®å…‰ã¨èåˆã™ã‚‹ã€åœ§å€’çš„ãªæ²¡å…¥æ„Ÿã€‚

### ğŸ¨ æ²¡å…¥æ„Ÿã‚’é«˜ã‚ã‚‹ "Live Venue" UI
- **Cross Stage ãƒ†ãƒ¼ãƒ**:
  - ãƒ€ãƒ¼ã‚¯ãªãƒ©ã‚¤ãƒ–ä¼šå ´ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ãŸèƒŒæ™¯ã¨ã€ãƒŸã‚¯ã‚°ãƒªãƒ¼ãƒ³ (`#39C5BB`) ã®ãƒã‚ªãƒ³ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã€‚
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ï¼ˆã™ã‚Šã‚¬ãƒ©ã‚¹åŠ¹æœï¼‰ã‚’å–ã‚Šå…¥ã‚ŒãŸãƒ¢ãƒ€ãƒ³ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚
- **ãƒªãƒƒãƒãªæ¼”å‡º**:
  - CSS/SVG ã‚’é§†ä½¿ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
  - æ¥½æ›²ã®ãƒ“ãƒ¼ãƒˆã«åˆã‚ã›ã¦è„ˆæ‰“ã¤ãƒ©ã‚¤ãƒˆã‚„ã€è¦³å®¢ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆæ¼”å‡ºã€‚

### ğŸµ TextAlive ã«ã‚ˆã‚‹ã€Œç”ŸããŸã€æ­Œè©ä½“é¨“
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**:
  - æ¥½æ›²ã®é€²è¡Œã«åˆã‚ã›ã¦æ­Œè©ãŒå‹•çš„ã«ç”Ÿæˆãƒ»é…ç½®ã•ã‚Œã¾ã™ã€‚
  - å˜ãªã‚‹ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªãã€æ¥½æ›²ã®ä¸€éƒ¨ã¨ã—ã¦æ¼”å‡ºã•ã‚Œã‚‹ã€Œãƒªãƒªãƒƒã‚¯ã‚¢ãƒ—ãƒªã€ã¨ã—ã¦ã®å´é¢ã€‚
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**:
  - API åˆ¶é™æ™‚ã‚„ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã§ã‚‚ãƒ—ãƒ¬ã‚¤ã‚’ç¶™ç¶šã§ãã‚‹å …ç‰¢ãªè¨­è¨ˆã€‚

### ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
- **Supabase é€£æº**:
  - ãƒ—ãƒ¬ã‚¤çµæœï¼ˆã‚¹ã‚³ã‚¢ã€ã‚³ãƒ³ãƒœã€ãƒ©ãƒ³ã‚¯ï¼‰ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã€‚
  - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åç™»éŒ²æ©Ÿèƒ½ä»˜ãã€‚
- **å¤šæ©Ÿèƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚°**:
  - ãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼ˆãƒã‚¦ã‚¹/ã‚«ãƒ¡ãƒ©ï¼‰ã€æœŸé–“åˆ¥ï¼ˆå…¨æœŸé–“/24æ™‚é–“ï¼‰ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«å¯¾å¿œã€‚
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ä¸–ç•Œä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ç«¶ãˆã¾ã™ã€‚

### ğŸ›¡ï¸ å …ç‰¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¨­è¨ˆ
- **é›¢è„±é˜²æ­¢ã‚¬ãƒ¼ãƒ‰**:
  - èª¤ã£ã¦ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚„ã€Œãƒªãƒ­ãƒ¼ãƒ‰ã€ã‚’æŠ¼ã—ã¦ã‚‚ã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚²ãƒ¼ãƒ ä¸­æ–­ã‚’é˜²ãã¾ã™ã€‚
- **SPA (Single Page Application)**:
  - Hono ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã‚‹ SPA ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ã§ã€ã©ã® URL ã‹ã‚‰ã§ã‚‚æ­£ã—ãã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã€‚
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹é«˜é€Ÿãªç”»é¢é·ç§»ã€‚

---

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ (Tech Stack)

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | è©³ç´° |
|---------|------|------|
| **Frontend** | **React 18 + Vite** | é«˜é€Ÿãªãƒ“ãƒ«ãƒ‰ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŒ‡å‘ UI |
| | **Tailwind CSS** | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° |
| **Game Core** | **TextAlive App API** | æ­Œè©åŒæœŸãƒ»æ¥½æ›²å†ç”Ÿåˆ¶å¾¡ |
| | **MediaPipe** | Pose / Selfie Segmentation (èº«ä½“èªè­˜) |
| **Backend** | **Cloudflare Workers** | Hono ã‚’å‹•ä½œã•ã›ã‚‹ã‚¨ãƒƒã‚¸ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  |
| | **Hono** | è»½é‡ãƒ»é«˜é€Ÿãª Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| **Database** | **Supabase** | PostgreSQL (pgcrypto, RLS) |
| **Infra** | **Docker** | é–‹ç™ºç’°å¢ƒã®ã‚³ãƒ³ãƒ†ãƒŠåŒ– |

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (Architecture)

### 1. Backend Architecture (Hono + Workers)

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ã€**MVP (Minimum Viable Product)** ã¨ã—ã¦ã€Œå¤§ä¼šã§èªã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã€ã®å“è³ªã¨ã€Œå®Ÿè£…ã—ãã‚Œã‚‹ç¯„å›²ã€ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

#### è¨­è¨ˆæ€æƒ³
*   **Single Table Design**: `scores` ãƒ†ãƒ¼ãƒ–ãƒ« 1 æšã®ã¿ã§æ§‹æˆã—ã€è¤‡é›‘ãªãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ’é™¤ã€‚
*   **Middleware Chain**:
    *   `requestId`: å…¨ãƒ­ã‚°ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«è¿½è·¡ ID ã‚’ä»˜ä¸ã€‚
    *   `session`: `cs_session` ã‚¯ãƒƒã‚­ãƒ¼ã«ã‚ˆã‚‹åŒ¿åã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§ã‚¹ã‚³ã‚¢ç´ä»˜ã‘ï¼‰ã€‚
    *   `admin`: ç®¡ç†è€…ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹èªè¨¼ã€‚
*   **Security & Validation**:
    *   **Zod**: å³æ ¼ãªå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
    *   **Origin Check**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®æ­£è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿è¨±å¯ã€‚
    *   **Cheat Detection**: ç•°å¸¸ã‚¹ã‚³ã‚¢ï¼ˆ1,000,000ç‚¹è¶…ï¼‰ã¯ `is_suspicious` ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ã—ãƒ©ãƒ³ã‚­ãƒ³ã‚°é™¤å¤–ã€‚

### 2. Frontend Architecture (Game Core)

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ã€Œå˜ä¸€è²¬ä»»ã®åŸå‰‡ (SRP)ã€ã«åŸºã¥ãã€æ©Ÿèƒ½ã”ã¨ã«ã‚¯ãƒ©ã‚¹ã‚’åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚

```mermaid
classDiagram
    GameManager --> UIManager
    GameManager --> BodyDetectionManager
    GameManager --> LyricsRenderer
    GameManager --> EffectsManager
    GameManager --> ResultsManager
    GameManager --> InputManager
    GameManager --> LiveStageVisuals
    GameManager --> GameLoop
    GameManager --> BubblePool
    GameManager --> TimerManager
```

*   **GameManager**: ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ç®¡ç†ãƒ»å†ç”Ÿåˆ¶å¾¡ã€‚
*   **BodyDetectionManager**: MediaPipe ã‚’ç”¨ã„ãŸå…¨èº«æ¤œå‡ºãƒ»åˆ¤å®šã€‚
*   **LyricsRenderer**: æ­Œè©ãƒãƒ–ãƒ«ã®ç”Ÿæˆã¨æç”»ã€‚

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ (Database Schema)

Supabase (PostgreSQL) ã® `scores` ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã§ã™ã€‚

```sql
create table public.scores (
  id uuid primary key default gen_random_uuid(),
  session_id text not null,      -- åŒ¿åã‚»ãƒƒã‚·ãƒ§ãƒ³ID (Cookie)
  song_id text not null,         -- æ¥½æ›²ID
  mode text not null,            -- 'cursor' or 'body'
  score integer not null,        -- ã‚¹ã‚³ã‚¢
  max_combo integer not null,    -- æœ€å¤§ã‚³ãƒ³ãƒœæ•°
  rank text not null,            -- ãƒ©ãƒ³ã‚¯ (SS, S, A...)
  accuracy numeric(5,2),         -- å‘½ä¸­ç‡
  is_suspicious boolean default false, -- ãƒãƒ¼ãƒˆç–‘æƒ‘ãƒ•ãƒ©ã‚°
  player_name text,              -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
  created_at timestamptz default now()
);

create index scores_song_mode_idx on public.scores (song_id, mode, score desc);
```

---

## ğŸ”Œ API ä»•æ§˜ (API Specification)

ãƒ™ãƒ¼ã‚¹ URL: `https://<worker-domain>/api/v1`

### 1. ã‚¹ã‚³ã‚¢ç™»éŒ²
**POST** `/scores`

*   **Headers**: `Content-Type: application/json`
*   **Body**:
    ```json
    {
      "playerName": "Guest",
      "songId": "song_123",
      "mode": "cursor",
      "score": 10000,
      "maxCombo": 50,
      "rank": "S",
      "accuracy": 95.5
    }
    ```
*   **Response**: ç™»éŒ²ã•ã‚ŒãŸã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿

### 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
**GET** `/scores`

*   **Query**:
    *   `songId` (å¿…é ˆ): æ¥½æ›²ID
    *   `mode` (ä»»æ„): `cursor` (default) or `body`
    *   `limit` (ä»»æ„): å–å¾—ä»¶æ•° (max 50)
*   **Response**:
    ```json
    {
      "data": [
        { "playerName": "User1", "score": 12000, "rank": "SS", ... }
      ],
      "meta": { "count": 20, "total": 100 }
    }
    ```

### 3. ç®¡ç†è€…ç”¨å…¨å‰Šé™¤
**DELETE** `/admin/scores`

*   **Headers**: `x-admin-token: <ADMIN_TOKEN>`
*   **Response**: `{ "data": { "deleted": 100 } }`

---

## ğŸš€ é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Development Setup)

### å¿…è¦è¦ä»¶
*   Node.js 20+
*   Cloudflare Account (Workers åˆ©ç”¨æ™‚)
*   Supabase Project

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
`.dev.vars` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«ä½œæˆï¼ˆWorkers ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰:
```ini
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
ADMIN_TOKEN=secret-token
FRONTEND_ORIGIN=http://localhost:5173
```

### 2. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®èµ·å‹•
```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ & ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŒæ™‚èµ·å‹•
npm run dev
```
*   Frontend: `http://localhost:5173`
*   Backend (Worker): `http://localhost:8787`

### 3. ãƒ‡ãƒ—ãƒ­ã‚¤ (Cloudflare Workers)
```bash
# ãƒ­ã‚°ã‚¤ãƒ³
npx wrangler login

# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®š
npx wrangler secret put SUPABASE_URL
npx wrangler secret put SUPABASE_ANON_KEY
npx wrangler secret put ADMIN_TOKEN

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy
```

---

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ (Directory Structure)

```
star-5/
â”œâ”€â”€ src/                  # Frontend (React)
â”‚   â”œâ”€â”€ components/       # UI Components
â”‚   â”œâ”€â”€ game/             # Game Logic (Managers)
â”‚   â””â”€â”€ pages/            # Page Components
â”œâ”€â”€ worker/               # Backend (Cloudflare Workers)
â”‚   â”œâ”€â”€ index.ts          # Entry Point
â”‚   â”œâ”€â”€ supabaseClient.ts # DB Client
â”‚   â”œâ”€â”€ middleware/       # Custom Middleware
â”‚   â”œâ”€â”€ routes/           # API Routes
â”‚   â””â”€â”€ types/            # Type Definitions
â”œâ”€â”€ docker-compose.yml    # Docker Config
â”œâ”€â”€ wrangler.jsonc        # Workers Config
â””â”€â”€ README.md             # This file
```

---

## ğŸ“œ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ & ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ

This project is licensed under the MIT License.

*   **TextAlive App API**: Powered by TextAlive (AIST).
*   **Songle**: Powered by Songle (AIST).
