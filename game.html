<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- ビューポート設定を修正 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>マジカルミライ - 初音ミクのアリーナライブ</title>
    <!-- iOS向けスタイルシートを先に読み込み -->
    <style>
        /* iOS用の初期調整スタイル */
        @supports (-webkit-touch-callout: none) {
            html, body {
                height: 100vh;
                height: -webkit-fill-available;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            
            /* ブラウザによるバウンス効果（スクロール可能な場合に端でバウンスする効果）を防止 */
            body {
                position: fixed;
                width: 100%;
                height: 100%;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/textalive-app-api/dist/index.js"></script>
    <script>
        // iOS向けの初期化コード
        function initializeIOSView() {
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                // iOSデバイスであることを示すクラスを追加
                document.body.classList.add('ios-device');
                
                // ビューポート高さを設定
                function setViewportHeight() {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                    
                    // ホームインジケータの高さを検出して調整
                    const windowHeight = window.innerHeight;
                    const screenHeight = window.screen.height;
                    let bottomInset = 0;
                    
                    // iPhoneXシリーズ以降のホームインジケータに対応
                    if (screenHeight >= 812) {
                        bottomInset = Math.max(34, screenHeight - windowHeight);
                    }
                    
                    document.documentElement.style.setProperty('--browser-footer-height', `${bottomInset}px`);
                }
                
                // 読み込み時と回転時に実行
                window.addEventListener('load', setViewportHeight);
                window.addEventListener('resize', setViewportHeight);
                window.addEventListener('orientationchange', () => {
                    setTimeout(setViewportHeight, 200);
                });
                
                // スクロールを防止
                document.body.addEventListener('touchmove', function(e) {
                    if (e.target.closest('#game-container')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // 初回実行
                setViewportHeight();
            }
        }
        
        // 即時実行
        initializeIOSView();
    </script>
    <script src="game-loader.js"></script>
    <script src="script.js"></script>
</head>
<body class="browser-bar-adjust">
    <div id="game-container">
        <div id="stage"></div>
        <div id="stage-light"></div>
        <div id="miku"></div>
        <div id="song-info">
            <div id="song-title">マジカルミライ2025</div>
            <div id="loading">初音ミクのアリーナライブ</div>
        </div>
        <div id="score-container">
            <div id="score">0</div>
            <div id="combo">コンボ: 0</div>
        </div> 
        <div id="instructions">歌詞の文字にマウスを当ててポイントを獲得しよう！</div>
        <div id="controls">
            <button id="play-pause">再生</button>
            <button id="restart">最初から</button>
        </div>
    </div>
    <div id="results-screen" class="hidden">
        <div class="results-container">
            <div class="results-score-section">
                <h2>リザルト</h2>
                <div id="final-score-display">0</div>
                <div id="final-combo-display">最大コンボ: 0</div>
                <div id="rank-display">ランク: S</div>
            </div>
            <div class="results-miku-section">
                <div id="results-miku"></div>
            </div>
        </div>
        <div class="results-buttons">
            <button id="back-to-title">タイトルへ戻る</button>
            <button id="replay-song">もう一度プレイ</button>
        </div>
    </div>
    <script>
        // ビューポート高さを設定するための初期化処理
        function setVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // 初期化時と画面サイズ変更時に実行
        setVh();
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', () => {
            setTimeout(setVh, 100);
        });
        
        // iOS特有の問題を解決するための追加処理
        if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
            // iOSのダブルタップによるズームを防止
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 画面全体をタップ可能に
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            }, { passive: false });
        }
    </script>
</body>
</html>