# 仕様書 - Cross Stage

## 1. システム概要
Cross Stage は、TextAlive による歌詞同期と MediaPipe による身体検知を組み合わせた Web リズムゲームです。フロントエンドは React/Vite の SPA、バックエンドは Cloudflare Workers + Hono、データストアは Supabase (PostgreSQL) を利用します。

```mermaid
flowchart LR
  Player[プレイヤー] -->|操作| FE[Frontend<br/>(React/Vite)]
  FE -->|歌詞同期| TextAlive[TextAlive App API]
  FE -->|姿勢/手/人物抽出| MediaPipe[MediaPipe Pose/Hands/SelfieSegmentation]
  FE -->|スコア/ランキング| API[Cloudflare Workers + Hono]
  FE -->|静的配信| Assets[Workers Assets (docs)]
  API -->|Insert/Select| DB[(Supabase Postgres)]
  API -->|Bot対策| Turnstile[Cloudflare Turnstile]
  API -->|レート制限/Nonce| DO[Durable Object RateLimiter]
```

## 2. 機能階層図
```mermaid
graph TD
  A[Cross Stage]
  A --> B[ゲームプレイ]
  B --> B1[モード管理]
  B --> B2[歌詞同期/TextAlive]
  B --> B3[判定/スコア/コンボ]
  B --> B4[ホールドスコア]
  B --> B5[結果/リザルト]
  A --> C[カメラ/入力]
  C --> C1[Pose検出]
  C --> C2[Hands検出]
  C --> C3[人物抽出]
  C --> C4[警告/補助UI]
  A --> D[UI/演出]
  D --> D1[歌詞バブル]
  D --> D2[スコア/コンボHUD]
  D --> D3[パーティクル/3D演出]
  A --> E[ランキング]
  E --> E1[スコア登録]
  E --> E2[ランキング取得]
  E --> E3[ランキングUI]
  A --> F[バックエンド]
  F --> F1[API/検証]
  F --> F2[レート制限]
  F --> F3[管理API]
  A --> G[データストア]
  G --> G1[(scores)]
```

## 3. IPO図（主要機能）
```mermaid
flowchart TB
  subgraph Gameplay[ゲームプレイ/スコアリング]
    GP_In[Input: TextAliveタイミング, プレイヤー入力, カメラLandmarks]
    GP_Proc[Process: バブル生成, ヒット/ホールド判定, コンボ/スコア計算]
    GP_Out[Output: スコアUI, 演出, リザルト]
    GP_In --> GP_Proc --> GP_Out
  end

  subgraph Camera[カメラ認識]
    C_In[Input: Webカメラ映像]
    C_Proc[Process: Pose/Hands/Segmentation, 品質/負荷制御]
    C_Out[Output: ランドマーク/人体マスク/判定イベント]
    C_In --> C_Proc --> C_Out
  end

  subgraph ScoreSubmit[スコア登録]
    S_In[Input: GameResult, x-score-token?, turnstileToken?]
    S_Proc[Process: Origin/Rate limit/HMAC/Turnstile検証, Supabase挿入]
    S_Out[Output: 保存結果/エラー]
    S_In --> S_Proc --> S_Out
  end

  subgraph RankingFetch[ランキング取得]
    R_In[Input: songId, mode?, period?, limit?]
    R_Proc[Process: 検証, DB検索, フィルタ/ソート]
    R_Out[Output: ランキング一覧]
    R_In --> R_Proc --> R_Out
  end
```

## 4. 画面遷移図
```mermaid
stateDiagram-v2
  state "タイトル/曲選択" as Index
  state "ゲーム" as Game
  state "リザルト" as Results
  state "ランキング(モーダル)" as Ranking
  state "終了確認(モーダル)" as ExitConfirm

  [*] --> Index
  Index --> Game: START
  Index --> Ranking: ランキング表示
  Ranking --> Index: 閉じる
  Game --> Results: 曲終了/強制終了
  Results --> Game: もう一度
  Results --> Index: タイトルへ
  Game --> Ranking: ランキング表示
  Ranking --> Game: 閉じる
  Game --> ExitConfirm: 戻る/ブラウザバック
  ExitConfirm --> Game: 続ける
  ExitConfirm --> Index: 終了
```

## 5. 全体インターフェース図（システム構成）
```mermaid
flowchart LR
  Client[Web Client] -->|GET /api/config| API[Workers API]
  Client -->|GET /api/token| API
  Client -->|POST /api/score| API
  Client -->|GET /api/ranking| API
  Admin[Admin Tool] -->|DELETE /admin/scores| API
  API -->|Insert/Select| DB[(Supabase)]
  API -->|Verify| Turnstile
  API -->|Rate limit/Nonce| DO[Durable Object]
  Client -->|Lyrics Sync| TextAlive
  Client -->|Pose/Segmentation| MediaPipe
```

### API一覧
| Method | Path | 概要 | 認証/条件 |
| --- | --- | --- | --- |
| GET | /api/health | ヘルスチェック | なし |
| GET | /api/config | Turnstile Site Key 取得 | なし |
| GET | /api/token | スコア署名トークン発行 | SCORE_SIGNING_SECRET 設定時のみ有効 |
| POST | /api/score | スコア登録 | FRONTEND_ORIGIN/Rate limit/HMAC/Turnstile (条件付き) |
| GET | /api/ranking | ランキング取得 | songId 必須 |
| DELETE | /admin/scores | スコア削除 | x-admin-token 必須 |

### 環境変数（Workers）
| 変数 | 用途 |
| --- | --- |
| SUPABASE_URL | Supabase 接続 URL |
| SUPABASE_ANON_KEY | Supabase 匿名キー |
| FRONTEND_ORIGIN | Origin チェックの許可ドメイン |
| ADMIN_TOKEN | 管理APIトークン |
| TURNSTILE_SITE_KEY | Turnstile Site Key（公開） |
| TURNSTILE_SECRET_KEY | Turnstile Secret Key（検証） |
| SCORE_SIGNING_SECRET | スコア署名用シークレット |
| RATE_LIMITER | Durable Object バインディング |
| ASSETS | 静的アセット配信用 |

## 6. フローチャート
```mermaid
flowchart TD
  A[リザルト画面で登録] --> B[Client: POST /api/score]
  B --> C{Origin OK?}
  C -- No --> E[403 Forbidden]
  C -- Yes --> D[Rate limit check]
  D -- Exceed --> E2[429 Too Many Requests]
  D -- OK --> F{SCORE_SIGNING_SECRET?}
  F -- Yes --> G[HMAC token verify + nonce]
  G -- Fail --> E3[401/403/409]
  G -- OK --> H{Turnstile enabled?}
  F -- No --> H
  H -- Yes --> I[Turnstile verify]
  I -- Fail --> E4[403 Invalid Token]
  H -- No --> J[Supabase insert]
  I -- OK --> J
  J --> K{DB OK?}
  K -- No --> E5[500 DB Error]
  K -- Yes --> L[200 OK]
```

## 7. 全体モジュール分割図
```mermaid
graph TD
  subgraph Frontend
    UI[Pages/Components]
    Core[Game Core]
    Input[Input/Camera]
    Visuals[Effects/3D]
  end
  subgraph Backend
    Worker[Workers API]
    Rate[RateLimiter DO]
  end
  DB[(Supabase)]

  UI --> Core
  Core --> Input
  Core --> Visuals
  Core --> Worker
  Worker --> Rate
  Worker --> DB
```

## 8. クラス図
```mermaid
classDiagram
  class GameManager {
    +start()
    +togglePlay()
    +showResults()
    +submitScore()
  }
  class GameLoop {
    +start()
    +stop()
  }
  class TimerManager
  class BubblePool
  class LyricsRenderer
  class ResultsManager
  class UIManager
  class EffectsManager
  class InputManager
  class ViewportManager
  class BodyDetectionManager
  class LiveStageVisuals

  GameManager --> GameLoop
  GameManager --> TimerManager
  GameManager --> BubblePool
  GameManager --> LyricsRenderer
  GameManager --> ResultsManager
  GameManager --> UIManager
  GameManager --> EffectsManager
  GameManager --> InputManager
  GameManager --> ViewportManager
  GameManager --> BodyDetectionManager
  GameManager --> LiveStageVisuals
```

## 9. DBテーブル図
```mermaid
classDiagram
  class scores {
    uuid id
    text session_id
    text song_id
    text mode
    int score
    int max_combo
    text rank
    numeric accuracy
    boolean is_suspicious
    text player_name
    timestamptz created_at
  }
```

## 10. ER図
```mermaid
erDiagram
  SCORES {
    uuid id PK
    text session_id
    text song_id
    text mode
    int score
    int max_combo
    text rank
    numeric accuracy
    boolean is_suspicious
    text player_name
    timestamptz created_at
  }
```

## 11. DB設計（テーブル定義）
### scores
| カラム | 型 | 制約/デフォルト | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | レコードID |
| session_id | text | NOT NULL, default gen_random_uuid()::text | 匿名セッションID (Cookie) |
| song_id | text | NOT NULL | 楽曲ID |
| mode | text | NOT NULL, default 'cursor' | cursor/body/mobile/hand |
| score | integer | NOT NULL | スコア |
| max_combo | integer | NOT NULL | 最大コンボ |
| rank | text | NOT NULL | ランク |
| accuracy | numeric(5,2) | NULL | 精度(%) |
| is_suspicious | boolean | default false | チート疑い |
| player_name | text | NULL | プレイヤー名 |
| created_at | timestamptz | default now() | 登録時刻 |

### インデックス
- scores_song_mode_score_idx: (song_id, mode, score desc)

## 12. モジュール仕様書
| モジュール | 責務 | 主なファイル |
| --- | --- | --- |
| ルーティング/ページ | SPAルーティング、画面遷移 | src/App.tsx, src/pages/IndexPage.tsx, src/pages/GamePage.tsx |
| UIコンポーネント | ランキング表示、モード切替 | src/components/game/RankingModal.tsx, src/components/game/RankingPanel.tsx, src/components/game/ModeTabs.tsx |
| ゲームコア | ゲーム進行、スコア、リザルト | src/game/GameManager.ts, src/game/GameLoop.ts |
| 歌詞描画 | バブル生成、表示、判定補助 | src/game/GameManager.ts (LyricsRenderer) |
| 入力/カメラ | マウス/タッチ/カメラ入力、Pose判定 | src/game/GameManager.ts (InputManager, BodyDetectionManager) |
| 演出/ビジュアル | パーティクル/3D/スコアポップ | src/game/GameManager.ts (EffectsManager, LiveStageVisuals), src/game/gameLoader.ts |
| タイマ/プール | ループ補助、DOM再利用 | src/game/TimerManager.ts, src/game/BubblePool.ts |
| Workers API | スコア登録/ランキング取得/管理 | worker/index.ts, worker/routes/score.ts, worker/routes/admin.ts |
| ミドルウェア | requestId, session, admin 認証 | worker/middleware/* |
| レート制限 | Durable Object による制限/Nonce | worker/rateLimiter.ts |
| DBスキーマ | scores テーブル定義 | supabase_scores.sql, worker/types/supabase.ts |
| ローカルサーバ | 開発用API/静的配信 | server/index.ts, server/routes/score.ts |

## 13. テスト仕様書
| ID | 対象 | 種別 | 手順/入力 | 期待結果 |
| --- | --- | --- | --- | --- |
| API-01 | POST /api/score | 結合 | 正常スコア送信 | 200 かつ scores に保存 |
| API-02 | POST /api/score | セキュリティ | FRONTEND_ORIGIN 不一致 | 403 を返す |
| API-03 | POST /api/score | セキュリティ | SCORE_SIGNING_SECRET 設定時に token 欠落 | 401 を返す |
| API-04 | POST /api/score | セキュリティ | Turnstile 検証失敗 | 403 を返す |
| API-05 | GET /api/ranking | 結合 | songId 指定 | ランキング配列を返す |
| FE-01 | ゲーム進行 | E2E | START→プレイ→リザルト | リザルト表示/スコア表示 |
| FE-02 | ホールド判定 | 機能 | バブル長押し | スコアが連続加算される |
| FE-03 | フルコンボ | 機能 | 全歌詞ヒット | 1,000,000 に補正される |
| CAM-01 | カメラ認識 | 性能 | perf=auto/low/high/ultra 切替 | 追従性と負荷が切替わる |
| UI-01 | ランキングモーダル | UI | 開閉/期間切替 | 表示更新/閉じる |
| SEC-01 | 管理API | セキュリティ | x-admin-token なし | 401 を返す |
